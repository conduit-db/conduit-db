version: "3.8"

# This docker-compose is not for production use. It is solely for development and testing.

services:

  node:
    build:
      context: .
      dockerfile: ./contrib/node/Dockerfile
    ports:
      - "18332:18332"
      - "18444:18444"
    volumes:
    - bitcoin_data:/root/.electrumsv-node

  mysql:
    build:
      context: .
      dockerfile: ./contrib/mariadb/Dockerfile
    ports:
      - "52525:3306"
    environment:
      MYSQL_ROOT_PASSWORD: conduitpass
      MYSQL_DATABASE: conduitdb
      MYSQL_USER: conduitadmin
      MYSQL_PASSWORD: conduitpass

  conduit-raw:
    build:
      context: .
      dockerfile: ./conduit_raw/Dockerfile
    ports:
      - "50000:50000"
      - "34525:34525"
    depends_on:
      - node
    environment:
      - CONDUIT_RAW_API_HOST=0.0.0.0:50000
      - BITCOIN_HOST=node
      - BITCOIN_RPC_PORT=18332
      - LMDB_READONLY=0
      - LMDB_DATABASE_PATH=/opt/lmdb_data
    working_dir: /opt
    command: sh -c 'python3 /opt/conduit_raw/run_conduit_raw.py'

  conduit-index:
    build:
      context: .
      dockerfile: ./conduit_index/Dockerfile
    depends_on:
      - node
      - mysql
      - conduit-raw
    environment:
      - CONDUIT_RAW_API_HOST=conduit-raw:50000
      - CONDUIT_INDEX_HOST=conduit-index
    working_dir: /opt
    command: sh -c 'python3 /opt/conduit_index/run_conduit_index.py'
#    command: sh -c 'gdb -ex r --args python3 /opt/conduit_index/run_conduit_index.py'


volumes:
  bitcoin_data:
